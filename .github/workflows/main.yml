name: FastAPI CI/CD

on:
  push:
    branches: 
      - main 

jobs:
  CI:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout Code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.10'

        - name: Cache pip dependencies
          uses: actions/cache@v3
          id: cache-pip
          with:
            path: ~/.cache/pip
            key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
            restore-keys: |
              ${{ runner.os }}-pip-

        - name: Install dependencies
          run: |
            python -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

        - name: Run Tests
          run: |
            source venv/bin/activate
            pytest

        - name: Create archive of dependencies and API files
          run: |
            source venv/bin/activate
            mkdir -p build
            cd ./venv/lib/python3.10/site-packages
            zip -r9 ../../../../build/api.zip .
            cd - # go back to root
            zip -g build/api.zip -r ./api # Ajusta la ruta de 'api' según sea necesario

        - name: Verify Zip Content
          run: unzip -l build/api.zip

        - name: Upload zip file artifact
          uses: actions/upload-artifact@v3
          with:
            name: api
            path: build/api.zip

  CD:
    CD:
      runs-on: ubuntu-latest
      needs: [CI]
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  
      steps:
        - uses: actions/checkout@v4
  
        # Configurar las credenciales de AWS con el parámetro de región correcto
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v2
          with:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }} # Asegúrate de que esta línea esté correcta
  
        # Paso de depuración para verificar que las credenciales se configuran correctamente
        - name: Debug AWS Credentials with Verbose Output
          run: |
            set -x # Habilita modo de depuración
            aws sts get-caller-identity --debug
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  
        # Descargar el archivo Lambda
        - name: Download Lambda artifact
          uses: actions/download-artifact@v3
          with:
            name: api
  
        # Subir a S3
        - name: Upload to S3
          run: |
            aws s3 cp api.zip s3://fastapi1243/api.zip
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  
        # Desplegar la nueva versión de Lambda
        - name: Deploy new Lambda
          run: |
            aws lambda update-function-code --function-name fastapi --s3-bucket fastapi1243 --s3-key api.zip
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  
        # Verificar el despliegue de Lambda
        - name: Verify Lambda Deployment
          run: |
            aws lambda get-function --function-name fastapi
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}